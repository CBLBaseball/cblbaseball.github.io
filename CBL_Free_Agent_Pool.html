<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CBL – Free Agent Pool</title>
  <style>
    :root{
      --bg:#fff;
      --ink:#101214;
      --muted:#4b5563;
      --line: rgba(0,0,0,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --accent:#0b3d91;
      --pill:#eef2ff;
      --pillInk:#1e40af;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);padding:10px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .title h1{margin:0;font-size:18px;letter-spacing:.02em}
    .title .sub{margin-top:2px;color:var(--muted);font-weight:650;font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:12px;text-decoration:none;color:inherit;font-weight:900}
    .btn:hover{border-color:rgba(11,61,145,.55);color:var(--accent)}
    .layout{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 52px)}
    #sidebar{border-right:1px solid var(--line);padding:12px;position:sticky;top:52px;height:calc(100vh - 52px);overflow:auto;background:#fff}
    .sectionTitle{margin:10px 0 6px;font-weight:950;color:#000;text-transform:uppercase;font-size:12px;letter-spacing:.08em}
    .link{width:100%;text-align:left;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 10px;margin:6px 0;cursor:pointer;font-weight:850;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .link:hover{border-color:rgba(0,0,0,.28)}
    .link.active{outline:3px solid rgba(11,61,145,.18);border-color:rgba(11,61,145,.5)}
    .pill{font-size:11px;background:var(--pill);color:var(--pillInk);padding:3px 8px;border-radius:999px;border:1px solid rgba(30,64,175,.18);font-weight:950}
    #main{padding:14px;min-width:0}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 8px;font-size:14px;letter-spacing:.06em;text-transform:uppercase}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{color:var(--muted);font-weight:650;font-size:12px;line-height:1.35}
    #search{width:320px;max-width:100%;padding:10px 10px;border:1px solid var(--line);border-radius:12px;font-weight:750}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 8px;border-bottom:1px solid rgba(0,0,0,.08);font-size:13px;white-space:nowrap}
    th{position:sticky;top:0;background:#fff;z-index:2;text-align:left;font-size:12px;letter-spacing:.06em;text-transform:uppercase}
    tbody tr:hover td{background:rgba(11,61,145,.03)}
    .tableWrap{max-height:70vh;overflow:auto;margin-top:10px;border:1px solid rgba(0,0,0,.08);border-radius:12px}
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      #sidebar{position:relative;top:0;height:auto;overflow:visible}
      th{top:0}
    }
  /* Ensure any accidental anchor HTML renders as plain text (no link styling/click) */
#tbl a { color: inherit !important; text-decoration: none !important; pointer-events: none !important; cursor: default !important; }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">
      <h1>CBL Free Agent Pool</h1>
      <div class="sub">2025 standard leaderboards • data refreshed automatically by GitHub Actions</div>
    </div>
    <a class="btn" href="dashboards.html">Back to Dashboards</a>
  </div>

  <div class="layout" id="app">
    <aside id="sidebar">
      <div class="sectionTitle">Hitters A–M</div>
      <button class="link active" data-file="data/fa/hit_am_bat_all.json">All <span class="pill">BAT</span></button>
      <button class="link" data-file="data/fa/hit_am_bat_lhp.json">vs LHP <span class="pill">BAT</span></button>
      <button class="link" data-file="data/fa/hit_am_bat_rhp.json">vs RHP <span class="pill">BAT</span></button>

      <div class="sectionTitle" style="margin-top:14px;">Hitters N–Z</div>
      <button class="link" data-file="data/fa/hit_nz_bat_all.json">All <span class="pill">BAT</span></button>
      <button class="link" data-file="data/fa/hit_nz_bat_lhp.json">vs LHP <span class="pill">BAT</span></button>
      <button class="link" data-file="data/fa/hit_nz_bat_rhp.json">vs RHP <span class="pill">BAT</span></button>

      <div class="sectionTitle" style="margin-top:14px;">Starting Pitchers</div>
      <button class="link" data-file="data/fa/sp_pit_all.json">All <span class="pill">PIT</span></button>
      <button class="link" data-file="data/fa/sp_pit_lhb.json">vs LHB <span class="pill">PIT</span></button>
      <button class="link" data-file="data/fa/sp_pit_rhb.json">vs RHB <span class="pill">PIT</span></button>

      <div class="sectionTitle" style="margin-top:14px;">Relief Pitchers A–M</div>
      <button class="link" data-file="data/fa/rp_am_pit_all.json">All <span class="pill">PIT</span></button>
      <button class="link" data-file="data/fa/rp_am_pit_lhb.json">vs LHB <span class="pill">PIT</span></button>
      <button class="link" data-file="data/fa/rp_am_pit_rhb.json">vs RHB <span class="pill">PIT</span></button>

      <div class="sectionTitle" style="margin-top:14px;">Relief Pitchers N–Z</div>
      <button class="link" data-file="data/fa/rp_nz_pit_all.json">All <span class="pill">PIT</span></button>
      <button class="link" data-file="data/fa/rp_nz_pit_lhb.json">vs LHB <span class="pill">PIT</span></button>
      <button class="link" data-file="data/fa/rp_nz_pit_rhb.json">vs RHB <span class="pill">PIT</span></button>

      <div class="small" style="margin-top:14px;">
        If you just uploaded this, the tables may be empty until the first GitHub Action run completes.
      </div>
    </aside>

    <main id="main">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2 id="tableTitle">Hitters A–M • All</h2>
            <div class="small" id="status">Loading…</div>
          </div>
          <input id="search" placeholder="Search (filters visible rows)…" />
        </div>
        <div class="tableWrap">
          <table id="tbl">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    const links = Array.from(document.querySelectorAll('.link'));
    const theadRow = document.getElementById('theadRow');
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const titleEl = document.getElementById('tableTitle');
    const search = document.getElementById('search');

    let currentRows = [];
    let currentCols = [];

    function prettyTitle(btn){
      const sec = btn.closest('#sidebar').querySelector('.sectionTitle'); // first sectionTitle, but we want the nearest previous
      return btn.textContent.replace(/\s+/g,' ').trim();
    }

    function nearestSectionTitle(btn){
      let el = btn.previousElementSibling;
      while(el){
        if(el.classList && el.classList.contains('sectionTitle')) return el.textContent.trim();
        el = el.previousElementSibling;
      }
      return "Free Agent Pool";
    }

    function renderTable(rows){
      tbody.innerHTML = '';
      if(!rows.length){
        statusEl.textContent = "No rows loaded yet. (Likely waiting for GitHub Action to generate JSON.)";
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        currentCols.forEach(c => {
          const td = document.createElement('td');
          (function(){
          const v = (r[c] ?? '');
          if (typeof v === 'string' && v.indexOf('<') !== -1 && v.indexOf('>') !== -1) {
            // If FanGraphs returns HTML (e.g., <a ...>Name</a>), strip tags safely.
            try {
              const doc = new DOMParser().parseFromString(v, 'text/html');
              td.textContent = (doc.body && doc.body.textContent) ? doc.body.textContent.trim() : v.replace(/<[^>]*>/g,'').trim();
            } catch (e) {
              td.textContent = v.replace(/<[^>]*>/g,'').trim();
            }
          } else {
            td.textContent = (v ?? '').toString();
          }
        })();
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      statusEl.textContent = rows.length + " rows";
    }

    function setColumnsFromRows(rows){
      // Use first row keys as columns; keeps "standard" preset order from FanGraphs table.
      currentCols = Object.keys(rows[0] || {});
      theadRow.innerHTML = '';
      currentCols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        theadRow.appendChild(th);
      });
    }

    async function loadFile(btn){
      const file = btn.getAttribute('data-file');
      const section = nearestSectionTitle(btn);
      const label = btn.textContent.replace(/\s+/g,' ').trim();
      titleEl.textContent = section + " • " + label.replace(/\s+BAT|\s+PIT/, '').trim();

      statusEl.textContent = "Loading…";
      try{
        const res = await fetch(file, {cache:'no-store'});
        if(!res.ok) throw new Error("HTTP " + res.status);
        const rows = await res.json();
        currentRows = rows;
        if(rows.length) setColumnsFromRows(rows);
        renderTable(rows);
      }catch(e){
        statusEl.textContent = "Could not load local data (" + file + "). Upload the /data/fa folder and ensure GitHub Action has run. " + e;
        tbody.innerHTML = '';
      }
    }

    function applySearch(){
      const q = (search.value || '').trim().toLowerCase();
      if(!q){ renderTable(currentRows); return; }
      const filtered = currentRows.filter(r => {
        return currentCols.some(c => (r[c] ?? '').toString().toLowerCase().includes(q));
      });
      renderTable(filtered);
    }

    links.forEach(btn => {
      btn.addEventListener('click', () => {
        links.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadFile(btn);
      });
    });

    search.addEventListener('input', applySearch);

    // initial load
    loadFile(document.querySelector('.link.active'));
  </script>
</body>
</html>
